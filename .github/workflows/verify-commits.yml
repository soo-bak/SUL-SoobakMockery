name: Verify Commits on Pull Request

on:
  pull_request:
    branches:
      - main

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        # All Histories
        fetch-depth: 0

    - name: Install GPG
      run: |
        sudo apt-get update
        sudo apt-get install -y gnupg

    - name: Fetch all commits for the PR
      run: |
        # Ensure all branches and commits
        git fetch origin main:refs/remotes/origin/main
        git fetch origin pull/${{ github.event.number }}/head:refs/remotes/origin/pr/${{ github.event.number }}/head

    - name: Verify GPG signatures
      run: |
        # Get the list of commits in the PR
        PR_COMMITS=$(git rev-list origin/main..origin/pr/${{ github.event.number }})

        # Iterate over each commit and verify its GPG signature
        for commit_hash in $PR_COMMITS; do
          echo "Verifying commit $commit_hash..."
          if git verify-commit $commit_hash; then
            echo "Commit $commit_hash is verified."
          else
            echo "Commit $commit_hash is not verified."
            exit 1
          fi
        done
